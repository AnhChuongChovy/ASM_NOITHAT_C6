@page "/TaiKhoan/{id:int}"
@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@using Microsoft.AspNetCore.Components.Forms
@using System.Text.Json
@using WebAsemly_NoiThat.Model

<div class="container">
    <div>
        <a class="dangxuat" href="/">Trang chủ</a> |
        <a>Thông tin tài khoản</a>
    </div>
    <div class="row">
        <div class="col-md-4">
            <div class="w-100" style="margin-top:30px">
                <div style="border-left: 10px solid royalblue">
                    <p style="font-size:25px; font-weight:bold; text-transform:uppercase; padding-left:10px">Tài khoản cá nhân</p>
                </div>
                <div class="text-center mt-2">
                    <img id="profileImagePreview" src="@account.HinhAnh" height="100px" width="100px" style="border-radius:50%; object-fit:cover; border:1px solid black"><br />
                    <label for="profileImage" class="btn btn-primary mt-2">
                        Chọn ảnh
                        <InputFile type="file" id="profileImage" name="profileImage" class="d-none" OnChange="HandleFileSelected" />
                    </label>
                </div>
            </div>
            <br />
            <div>
                <a class="dangxuat" href="/TaiKhoan">Thông tin tài khoản</a><br />
                <a class="dangxuat" href="/DonHang">Đơn hàng</a><br />
                <a class="dangxuat" href="/DoiMatKhau">Đổi mật khẩu</a> <br />
                <a class="dangxuat" href="/Logout">Đăng xuất</a>
            </div>
        </div>

        <div class="col-md-8">
            <h2 class="font-weight-bold text-uppercase" style="margin-top:30px">Thông Tin Tài Khoản</h2>
            <hr />
            <div class="form-group row">
                <div class="col-md-3">
                    <label for="TenND">Tên Người Dùng</label>
                </div>
                <div class="col-md-9">
                    <input type="text" class="form-control sua" id="TenND" @bind-value="account.TenNguoiDung" />
                </div>
            </div>

            <div class="form-group row">
                <div class="col-md-3">
                    <label for="Email">Email</label>
                </div>
                <div class="col-md-9">
                    <input type="email" class="form-control sua" id="Email" @bind-value="account.Email" />
                </div>
            </div>

            <div class="form-group row">
                <div class="col-md-3">
                    <label for="Diachi">Địa Chỉ</label>
                </div>
                <div class="col-md-9">
                    <input type="text" class="form-control sua" id="Diachi" @bind-value="account.DiaChi" />
                </div>
            </div>

            <div class="form-group row">
                <div class="col-md-3">
                    <label for="SDT">Số Điện Thoại</label>
                </div>
                <div class="col-md-9">
                    <input type="text" class="form-control sua" id="SDT" @bind-value="account.SDT" />
                </div>
            </div>

                <div class="form-group row">
                    <div class="col-md-3">
                        <label>Giới Tính</label>
                    </div>
                    <div class="col-md-9">
                        <InputRadioGroup @bind-Value="account.GioiTinh">
                            <div class="d-flex">
                                @foreach (var gender in new[] { "Nam", "Nữ" })
                                {
                                    <div class="form-check mr-3">
                                        <InputRadio id="@($"gioiTinh{gender}")" class="form-check-input" Value="@gender" />
                                        <label class="form-check-label" for="@($"gioiTinh{gender}")">@gender</label>
                                    </div>
                                }
                            </div>
                        </InputRadioGroup>
                    </div>
                </div>

            <button type="button" class="btn btn-primary" style="width: 150px; border-radius:0; padding:10px" @* @onclick="UpdateAccount" *@>Cập Nhật</button>
        </div>
    </div>
</div>



@code {
    [Parameter]
    public int id { get; set; } 
    private Account account = new Account();
    private IBrowserFile selectedFile;

    // Load thông tin tài khoản theo id đã lưu vào local
    protected override async Task OnInitializedAsync()
    {
        await LoadAccountInfo(id);
    }

    // Xử lý khi chọn tệp tin
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if (file != null)
        {
            // Tạo MultipartFormDataContent để gửi tệp tin đến API
            var content = new MultipartFormDataContent();
            var streamContent = new StreamContent(file.OpenReadStream());
            streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
            content.Add(streamContent, "file", file.Name);

            // Gửi tệp tin đến API
            var response = await Http.PostAsync("https://localhost:44320/api/Account/upload-account", content);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<JsonElement>();
                var fileUrl = result.GetProperty("FileUrl").GetString();
                account.HinhAnh = fileUrl;
                StateHasChanged();
            }
            else
            {
                Console.WriteLine("Lỗi khi tải lên tệp.");
            }
        }
    }

    // Cập nhật thông tin
    private async Task UpdateAccount()
    {
        var response = await Http.PutAsJsonAsync($"https://localhost:44320/api/Account/{account.ID}", account);

        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine("Cập nhật thành công!");
        }
        else
        {
            Console.WriteLine("Cập nhật không thành công.");
        }
    }
}